---
# ===============================
# SMM PANEL APPLICATION CONFIGURATION
# ===============================
# Main configuration file for the Social Media Marketing Panel
# 
# SECURITY NOTICE: All sensitive values are externalized to environment variables
# Ensure the following environment variables are set in production:
# - DB_PASSWORD, REDIS_PASSWORD, JWT_SECRET
# - BINOM_API_KEY, YOUTUBE_API_KEY, CRYPTOMUS_API_KEY, CRYPTOMUS_API_SECRET
# - CRYPTOMUS_WEBHOOK_SECRET, CRYPTOMUS_MERCHANT_ID
#
# For environment-specific overrides, use:
# - application-dev.yml (development)
# - application-stage.yml (staging) 
# - application-prod.yml (production)
# ===============================

# ===============================
# SERVER CONFIGURATION
# ===============================
server:
  port: 8080
  # context-path removed - paths are now explicit in controllers
  compression:
    enabled: true
    mime-types: >
      text/html,text/xml,text/plain,text/css,text/javascript,
      application/javascript,application/json
    min-response-size: 1024
  http2:
    enabled: true
  tomcat:
    connection-timeout: 20000
    keep-alive-timeout: 20000
    max-connections: 8192
    threads:
      max: 200
      min-spare: 10
  error:
    include-message: always
    include-binding-errors: always

# ===============================
# SPRING CONFIGURATION
# ===============================
spring:
  # Include Resilience4j configuration
  config:
    import: 
      - optional:classpath:application-resilience4j.yml
  # Application startup configuration
  main:
    lazy-initialization: false  # Ensure all beans are initialized at startup
    allow-bean-definition-overriding: false  # Prevent accidental bean overrides
    web-application-type: servlet
  lifecycle:
    timeout-per-shutdown-phase: 30s  # Grace period for shutdown
  # ===============================
  # DATABASE CONFIGURATION
  # ===============================
  datasource:
    url: >
      jdbc:postgresql://${DB_HOST:postgres}:${DB_PORT:5432}/${DB_NAME:smm_panel}
    username: ${DB_USER:smm_admin}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      # Connection pool sizing - Optimized for Windows/WSL2 environment
      # PostgreSQL max_connections should be set to 200 for this configuration
      maximum-pool-size: ${DB_MAX_POOL_SIZE:100}      # OPTIMIZED: Realistic for Windows/WSL2
      minimum-idle: ${DB_MIN_IDLE:30}                 # Keep 1/3 connections ready
      connection-timeout: ${DB_CONNECTION_TIMEOUT:30000}    # 30 seconds (increased)
      validation-timeout: ${DB_VALIDATION_TIMEOUT:5000}     # 5 seconds (added)
      idle-timeout: ${DB_IDLE_TIMEOUT:600000}        # 10 minutes
      max-lifetime: ${DB_MAX_LIFETIME:1800000}       # 30 minutes (must be < DB wait_timeout)
      connection-test-query: SELECT 1               # Health check query
      leak-detection-threshold: ${DB_LEAK_DETECTION_THRESHOLD:60000}  # 60 seconds
      pool-name: SMM-HikariPool                     # Named pool for monitoring
      register-mbeans: true                         # Enable JMX monitoring
      connection-init-sql: "SET statement_timeout = 30000"  # 30 second query timeout
  # ===============================
  # DATABASE MIGRATION - LIQUIBASE (SINGLE SOURCE OF TRUTH)
  # ===============================
  # IMPORTANT: Liquibase is the only migration tool. 
  # Flyway has been completely removed from this project.
  # All schema changes must go through Liquibase changeSets.
  
  # ===============================
  # LIQUIBASE CONFIGURATION
  # ===============================
  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.xml
    database-change-log-table: databasechangelog
    database-change-log-lock-table: databasechangeloglock
    enabled: ${SPRING_LIQUIBASE_ENABLED:true}
    contexts: ${SPRING_LIQUIBASE_CONTEXTS:dev}
    default-schema: public
    drop-first: false  # NEVER drop database on startup
    test-rollback-on-update: false
    
  # ===============================
  # SQL INIT - DISABLED (Using Liquibase)
  # ===============================
  sql:
    init:
      mode: never  # Disable Spring Boot SQL initialization
      
  jpa:
    hibernate:
      ddl-auto: none  ## Disable schema validation completely
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
    show-sql: ${SHOW_SQL:false}  # Set to true only for debugging
    properties:
      hibernate:
        # Explicitly set PostgreSQL dialect for Hibernate 6
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: ${HIBERNATE_FORMAT_SQL:false}
        use_sql_comments: ${HIBERNATE_SQL_COMMENTS:false}
        types:
          print:
            banner: false
        # PostgreSQL enum type handling
        default_schema: public
        
        # ===============================
        # HIBERNATE STATISTICS CONFIGURATION
        # ===============================
        generate_statistics: ${HIBERNATE_STATISTICS:false}  # Disabled to reduce logs
        
        # ===============================
        # JDBC BATCH CONFIGURATION
        # ===============================
        jdbc:
          batch_size: ${HIBERNATE_BATCH_SIZE:25}
          batch_versioned_data: true
          fetch_size: ${HIBERNATE_FETCH_SIZE:50}
          time_zone: UTC
          use_get_generated_keys: true  # PostgreSQL enum type handling
          lob:
            non_contextual_creation: true
        
        # ===============================
        # QUERY OPTIMIZATION
        # ===============================
        order_inserts: true
        order_updates: true
        default_batch_fetch_size: ${HIBERNATE_DEFAULT_BATCH_FETCH_SIZE:20}
        max_fetch_depth: 3
        enable_lazy_load_no_trans: false
        
        # ===============================
        # QUERY PLAN CACHE CONFIGURATION
        # ===============================
        query:
          plan_cache_max_size: ${HIBERNATE_QUERY_PLAN_CACHE_SIZE:2048}
          plan_parameter_metadata_max_size: ${HIBERNATE_QUERY_PLAN_PARAMETER_CACHE_SIZE:128}
          
        # ===============================
        # SECOND LEVEL CACHE CONFIGURATION
        # ===============================
        cache:
          use_second_level_cache: ${HIBERNATE_L2_CACHE_ENABLED:true}
          use_query_cache: ${HIBERNATE_QUERY_CACHE_ENABLED:true}
          region:
            factory_class: org.hibernate.cache.jcache.JCacheRegionFactory
        javax:
          cache:
            provider: org.ehcache.jsr107.EhcacheCachingProvider
            uri: classpath:ehcache-config.xml
          
        # ===============================
        # CONNECTION AND TRANSACTION
        # ===============================
        connection:
          provider_disables_autocommit: true
          autocommit: false
          isolation: 2  # READ_COMMITTED
          
        # ===============================
        # PERFORMANCE MONITORING
        # ===============================
        session_factory:
          statement_inspector: com.smmpanel.config.HibernateStatementInspector
        
        # ===============================
        # ADDITIONAL OPTIMIZATIONS
        # ===============================
        temp:
          use_jdbc_metadata_defaults: false
        event:
          merge:
            entity_copy_observer: allow
        
    open-in-view: false

  # ===============================
  # REDIS CONFIGURATION
  # ===============================
  data:
    redis:
      host: ${REDIS_HOST:redis}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0
      timeout: 2000ms
      # Using Lettuce client with optimized configuration
      lettuce:
        # Share native connection (best for single Redis instance per Stack Overflow)
        share-native-connection: true
        pool:
          enabled: true
          max-active: 10
          max-idle: 8
          min-idle: 0           # Set to 0 per best practice
          max-wait: 2000ms
          time-between-eviction-runs: 60s
        cluster:
          refresh:
            adaptive: true
            period: 30s
        shutdown-timeout: 100ms
        # Client options for better reliability
        client-options:
          auto-reconnect: true
          ping-before-activate-connection: true
        # Socket options for performance
        socket-options:
          keep-alive: true
          tcp-no-delay: true    # Reduce latency
  cache:
    type: redis
    redis:
      time-to-live: 300000
      key-prefix: "smm:cache:"
      use-key-prefix: true
      cache-null-values: false

  # ===============================
  # OAUTH2 CLIENT CONFIGURATION
  # ===============================
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID:}
            client-secret: ${GOOGLE_CLIENT_SECRET:}
            scope:
              - email
              - profile
              - openid
            redirect-uri: "{baseUrl}/login/oauth2/code/google"
            authorization-grant-type: authorization_code
            client-name: Google
          github:
            client-id: ${GITHUB_CLIENT_ID:}
            client-secret: ${GITHUB_CLIENT_SECRET:}
            scope:
              - user:email
              - read:user
            redirect-uri: "{baseUrl}/login/oauth2/code/github"
            authorization-grant-type: authorization_code
            client-name: GitHub
        provider:
          google:
            authorization-uri: https://accounts.google.com/o/oauth2/v2/auth
            token-uri: https://oauth2.googleapis.com/token
            user-info-uri: https://www.googleapis.com/oauth2/v3/userinfo
            user-name-attribute: sub
            jwk-set-uri: https://www.googleapis.com/oauth2/v3/certs
          github:
            authorization-uri: https://github.com/login/oauth/authorize
            token-uri: https://github.com/login/oauth/access_token
            user-info-uri: https://api.github.com/user
            user-name-attribute: id

  # ===============================
  # KAFKA CONFIGURATION
  # ===============================
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:kafka:9092}
    producer:
      key-serializer: >
        org.apache.kafka.common.serialization.StringSerializer
      value-serializer: >
        org.springframework.kafka.support.serializer.JsonSerializer
      acks: all
      retries: 3
      batch-size: 32768  # Increased for better throughput
      linger-ms: 10     # Batch messages for 10ms for better throughput
      buffer-memory: 33554432
      transaction-id-prefix: smm-panel-tx-
      properties:
        enable.idempotence: "true"
        compression.type: gzip
        delivery.timeout.ms: 120000
        request.timeout.ms: 30000
        max.in.flight.requests.per.connection: 5
        client.id: smm-panel-producer
        metrics.recording.level: INFO
        spring.json.type.mapping: >
          order:com.smmpanel.entity.Order,
          videoProcessing:com.smmpanel.entity.VideoProcessing,
          offerAssignment:com.smmpanel.dto.binom.OfferAssignmentRequest,
          offerAssignmentEvent:com.smmpanel.event.OfferAssignmentEvent,
          notification:java.util.Map,
          orderStateUpdate:java.util.Map
    consumer:
      key-deserializer: >
        org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: >
        org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      group-id: smm-panel-group
      auto-offset-reset: earliest
      enable-auto-commit: false
      isolation-level: read-committed
      max-poll-records: 50
      fetch-min-bytes: 1
      fetch-max-wait-ms: 500
      session-timeout-ms: 30000
      heartbeat-interval-ms: 3000
      max-poll-interval-ms: 900000  # 15 minutes - allows 3 orders @ 5min each concurrently
      properties:
        spring.deserializer.value.delegate.class: >
          org.springframework.kafka.support.serializer.JsonDeserializer
        spring.json.trusted.packages: >
          com.smmpanel.entity,com.smmpanel.dto,com.smmpanel.event,java.util
        partition.assignment.strategy: org.apache.kafka.clients.consumer.RangeAssignor
        client.id: smm-panel-consumer
        metrics.recording.level: INFO
        spring.json.type.mapping: >
          order:com.smmpanel.entity.Order,
          videoProcessing:com.smmpanel.entity.VideoProcessing,
          offerAssignment:com.smmpanel.dto.binom.OfferAssignmentRequest,
          offerAssignmentEvent:com.smmpanel.event.OfferAssignmentEvent,
          notification:java.util.Map,
          orderStateUpdate:java.util.Map
        spring.json.use.type.headers: false
        spring.json.value.default.type: java.util.Map
    listener:
      concurrency: 8  # Optimized for high throughput with proper thread pool sizing
      type: batch
      poll-timeout: 3000
      ack-mode: batch  # Batch acknowledgment for better performance
      missing-topics-fatal: false  # Continue even if topics don't exist yet
      idle-event-interval: 30000  # Send idle events every 30 seconds
    retry-topic:
      attempts: 3
      delay: 1000
      multiplier: 2.0
      max-delay: 10000
        
  # ===============================
  # KAFKA MONITORING CONFIGURATION  
  # ===============================
  kafka-monitoring:
    lag:
      threshold: ${KAFKA_LAG_THRESHOLD:10000}
    error:
      threshold: ${KAFKA_ERROR_THRESHOLD:0.05}
    dead-letter-queue:
      topic: ${KAFKA_DLQ_TOPIC:smm.video.processing.dlq}

  # ===============================
  # FILE UPLOAD CONFIGURATION
  # ===============================
  servlet:
    multipart:
      enabled: true
      max-file-size: 50MB
      max-request-size: 50MB
      file-size-threshold: 1MB

  # ===============================
  # ASYNC PROCESSING CONFIGURATION
  # ===============================
  task:
    execution:
      pool:
        core-size: 50  # Increased for high concurrency operations
        max-size: 100  # Doubled to handle increased load
        queue-capacity: 2000  # Increased queue capacity
      thread-name-prefix: sms-async-
    scheduling:
      pool:
        size: 20  # Increased for more scheduled tasks
      thread-name-prefix: sms-scheduled-

# ===============================
# APPLICATION CONFIGURATION
# ===============================
app:
  # ===============================
  # DATABASE POOL CONFIGURATION (MOVED TO DATASOURCE.HIKARI SECTION)
  # ===============================

  # ===============================
  # SECURITY CONFIGURATION
  # ===============================
  jwt:
    secret: ${JWT_SECRET}
    expiration-ms: ${JWT_EXPIRATION_MS:86400000}
    refresh-expiration-ms: ${JWT_REFRESH_EXPIRATION_MS:604800000}
  security:
    api-key:
      enabled: true
      header: X-API-Key
      hash-algorithm: SHA-256
      global-salt: ${API_KEY_GLOBAL_SALT:smm-panel-secure-salt-2024}
  cors:
    allowed-origins: >
      ${CORS_ORIGINS:http://localhost:3000,https://demo.perfectpanel.com}
    allowed-methods: "GET,POST,PUT,DELETE,OPTIONS"
    allowed-headers: "Authorization,Content-Type,X-API-Key,Accept,Origin"
    allow-credentials: true
    max-age: 3600

  # ===============================
  # OAUTH2 CONFIGURATION
  # ===============================
  oauth2:
    enabled: ${OAUTH2_ENABLED:true}
    providers:
      google:
        client-id: ${GOOGLE_CLIENT_ID:}
        client-secret: ${GOOGLE_CLIENT_SECRET:}
        redirect-uri: "{baseUrl}/login/oauth2/code/google"
        scope:
          - email
          - profile
      github:
        client-id: ${GITHUB_CLIENT_ID:}
        client-secret: ${GITHUB_CLIENT_SECRET:}
        redirect-uri: "{baseUrl}/login/oauth2/code/github"
        scope:
          - user:email
          - read:user
    success-redirect-url: ${OAUTH2_SUCCESS_URL:http://localhost:3000/dashboard}
    failure-redirect-url: ${OAUTH2_FAILURE_URL:http://localhost:3000/login?error=oauth2}

  # ===============================
  # RATE LIMITING CONFIGURATION
  # ===============================
  rate-limit:
    enabled: true
    orders:
      per-minute: 100
      per-hour: 1000
    api:
      per-minute: 300
      per-hour: 10000
    auth:
      per-minute: 60

  # ===============================
  # EXTERNAL API CONFIGURATIONS
  # ===============================
  binom:
    api:
      # Binom V2 API Configuration
      url: ${BINOM_API_URL}
      key: ${BINOM_API_KEY}
      username: ${BINOM_USERNAME:}
      password: ${BINOM_PASSWORD:}
    tracking:
      url: ${BINOM_TRACKING_URL:https://youtubershop.top}
      timeout: ${BINOM_API_TIMEOUT:30000}
      retry-attempts: ${BINOM_RETRY_ATTEMPTS:3}
      # V2 specific endpoints
      version: ${BINOM_API_VERSION:v2}
      endpoints:
        campaigns: ${BINOM_CAMPAIGNS_ENDPOINT:/v2/campaigns}
        offers: ${BINOM_OFFERS_ENDPOINT:/v2/offers}
        clicks: ${BINOM_CLICKS_ENDPOINT:/v2/clicks}
        conversions: ${BINOM_CONVERSIONS_ENDPOINT:/v2/conversions}
        statistics: ${BINOM_STATISTICS_ENDPOINT:/v2/statistics}
        landing-pages: ${BINOM_LANDING_PAGES_ENDPOINT:/v2/landing-pages}
        traffic-sources: ${BINOM_TRAFFIC_SOURCES_ENDPOINT:/v2/traffic-sources}
      # Enhanced authentication for V2
      auth:
        method: ${BINOM_AUTH_METHOD:api-key} # api-key, oauth2, bearer
        header: ${BINOM_AUTH_HEADER:X-API-Key}
        bearer-token: ${BINOM_BEARER_TOKEN:}
        oauth2:
          client-id: ${BINOM_OAUTH2_CLIENT_ID:}
          client-secret: ${BINOM_OAUTH2_CLIENT_SECRET:}
          token-url: ${BINOM_OAUTH2_TOKEN_URL:}
    # Business logic configuration
    default-coefficient: ${BINOM_DEFAULT_COEFFICIENT:3.0}
    max-campaigns-per-order: ${BINOM_MAX_CAMPAIGNS_PER_ORDER:5}
    # V2 Performance and monitoring
    monitoring:
      enabled: ${BINOM_MONITORING_ENABLED:true}
      metrics-interval: ${BINOM_METRICS_INTERVAL:300000} # 5 minutes
      health-check-interval: ${BINOM_HEALTH_CHECK_INTERVAL:60000} # 1 minute
      alert-thresholds:
        response-time-ms: ${BINOM_ALERT_RESPONSE_TIME:5000}
        error-rate-percent: ${BINOM_ALERT_ERROR_RATE:5.0}
        failure-rate-percent: ${BINOM_ALERT_FAILURE_RATE:10.0}
    # V2 Rate limiting and throttling
    rate-limiting:
      enabled: ${BINOM_RATE_LIMITING_ENABLED:true}
      requests-per-minute: ${BINOM_REQUESTS_PER_MINUTE:120}
      requests-per-hour: ${BINOM_REQUESTS_PER_HOUR:1000}
      burst-capacity: ${BINOM_BURST_CAPACITY:20}
    # V2 Caching configuration
    cache:
      enabled: ${BINOM_CACHE_ENABLED:true}
      ttl-minutes: ${BINOM_CACHE_TTL_MINUTES:5}
      campaigns-ttl: ${BINOM_CACHE_CAMPAIGNS_TTL:1800} # 30 minutes
      offers-ttl: ${BINOM_CACHE_OFFERS_TTL:3600} # 1 hour
      statistics-ttl: ${BINOM_CACHE_STATISTICS_TTL:300} # 5 minutes
      landing-pages-ttl: ${BINOM_CACHE_LANDING_PAGES_TTL:7200} # 2 hours
    # Sync configuration for cached API approach
    sync:
      enabled: ${BINOM_SYNC_ENABLED:true}
      interval-ms: ${BINOM_SYNC_INTERVAL:300000} # 5 minutes
      batch-size: ${BINOM_SYNC_BATCH_SIZE:100}
    # Statistics update configuration
    stats:
      update-interval-ms: ${BINOM_STATS_UPDATE_INTERVAL:60000} # 1 minute
  
  # Scheduling configuration for Binom sync job
  scheduling:
    binom-sync:
      enabled: ${BINOM_SYNC_SCHEDULER_ENABLED:true}
      interval-minutes: ${BINOM_SYNC_INTERVAL_MINUTES:5}
      batch-size: ${BINOM_SYNC_BATCH_SIZE:50}
      auto-pause-enabled: ${BINOM_AUTO_PAUSE_ENABLED:true}
  
  youtube:
    api:
      key: ${YOUTUBE_API_KEY}
      timeout: 15000
      retry-attempts: 2
    quota:
      daily-limit: ${YOUTUBE_QUOTA_DAILY_LIMIT:10000}
      per-minute-limit: ${YOUTUBE_QUOTA_PER_MINUTE:300}
      warning-threshold: ${YOUTUBE_QUOTA_WARNING_THRESHOLD:0.8}
      enabled: ${YOUTUBE_QUOTA_TRACKING_ENABLED:true}
    cache:
      ttl: ${YOUTUBE_CACHE_TTL:600}  # 10 minutes default
      video-stats-ttl: ${YOUTUBE_STATS_CACHE_TTL:300}  # 5 minutes for stats
      channel-ttl: ${YOUTUBE_CHANNEL_CACHE_TTL:3600}  # 1 hour for channel info
    clip-creation:
      enabled: ${YOUTUBE_CLIP_CREATION_ENABLED:true}
      coefficient: ${YOUTUBE_CLIP_COEFFICIENT:3.0}
      timeout: ${YOUTUBE_CLIP_TIMEOUT:300000}  # 5 minutes
      retry-attempts: ${YOUTUBE_CLIP_RETRY_ATTEMPTS:2}
  cryptomus:
    enabled: ${CRYPTOMUS_ENABLED:true}
    api:
      url: ${CRYPTOMUS_API_URL}
      ## User API Key for operations
      user-key: ${CRYPTOMUS_USER_API_KEY}
      ## Payout API Key for payout operations
      payout-key: ${CRYPTOMUS_PAYOUT_API_KEY}
      ## Merchant-specific fields (optional for simple user accounts)
      secret: ${CRYPTOMUS_API_SECRET:not-applicable}
    webhook:
      secret: ${CRYPTOMUS_WEBHOOK_SECRET:not-applicable}
    merchant-id: ${CRYPTOMUS_MERCHANT_ID:not-applicable}
    min-deposit: ${CRYPTOMUS_MIN_DEPOSIT:5.00}
    timeout: 30000

  # ===============================
  # CACHING CONFIGURATION
  # ===============================
  cache:
    # Cache TTL values in seconds - standardized across environments
    services:
      ttl: ${CACHE_SERVICES_TTL:3600}      # 1 hour - service data changes infrequently
    users:
      ttl: ${CACHE_USERS_TTL:1800}         # 30 minutes - user data moderately dynamic
    conversion-coefficients:
      ttl: ${CACHE_COEFFICIENTS_TTL:7200}  # 2 hours - coefficients change rarely
    youtube-stats:
      ttl: ${CACHE_YOUTUBE_TTL:600}        # 10 minutes - stats need regular updates

  # ===============================
  # FILE UPLOAD & PROCESSING
  # ===============================
  file:
    upload:
      path: ${FILE_UPLOAD_PATH:/tmp/smm-panel/uploads}
    processing:
      timeout: 300
      max-concurrent: 3

  # ===============================
  # ERROR HANDLING CONFIGURATION
  # ===============================
  error:
    include-stack-trace: ${ERROR_INCLUDE_STACK_TRACE:false}
    include-debug-info: ${ERROR_INCLUDE_DEBUG_INFO:false}

  # ===============================
  # BUSINESS LOGIC CONFIGURATION
  # ===============================
  order:
    processing:
      batch-size: 100
      max-retries: 3
      retry-delay: 5000
      timeout: 300000
  video:
    processing:
      max-concurrent: 5
      timeout: 600000
      clip-length: 60
      quality: medium
  balance:
    minimum-deposit: 1.00
    maximum-deposit: 10000.00
    transaction-timeout: 300000
    retry:
      max-attempts: 5
      initial-delay: 100
      max-delay: 5000
      multiplier: 2.0
  
  # ===============================
  # TRANSACTION MANAGEMENT
  # ===============================
  transaction:
    monitoring:
      enabled: ${TRANSACTION_MONITORING_ENABLED:false}
    trace:
      enabled: ${TRANSACTION_TRACE_ENABLED:false}
    isolation:
      balance-operations: SERIALIZABLE
      order-operations: REPEATABLE_READ
      read-operations: READ_COMMITTED
    timeout:
      balance-operations: 10
      order-operations: 30
      read-operations: 15
      default: 30
  perfectpanel:
    compatible: "true"
    api-version: "2.0"
    status-mapping:
      enabled: "true"

  # ===============================
  # DEVELOPMENT/DEBUG SETTINGS
  # ===============================
  features:
    youtube-processing:
      enabled: ${YOUTUBE_PROCESSING_ENABLED:true}
    binom-integration:
      enabled: ${BINOM_INTEGRATION_ENABLED:true}
    payment-processing:
      enabled: ${PAYMENT_PROCESSING_ENABLED:true}
    email-notifications:
      enabled: ${EMAIL_NOTIFICATIONS_ENABLED:true}
  monitoring:
    enabled: true
    slow-query-threshold: 1000
    memory-threshold: 80
    cpu-threshold: 80
    query-count:
      enabled: ${QUERY_COUNT_MONITORING_ENABLED:false}
      warn-threshold: 5
      error-threshold: 10
    connection-pool:
      high-usage-threshold: ${CONNECTION_POOL_HIGH_USAGE_THRESHOLD:75}
      critical-usage-threshold: ${CONNECTION_POOL_CRITICAL_USAGE_THRESHOLD:90}
      slow-query-threshold: ${CONNECTION_POOL_SLOW_QUERY_THRESHOLD:5000}
      
  # ===============================
  # SELENIUM CONFIGURATION
  # ===============================
  selenium:
    hub:
      url: ${SELENIUM_HUB_URL:http://localhost:4444/wd/hub}
      timeout: ${SELENIUM_HUB_TIMEOUT:300000}
    browser:
      headless: ${SELENIUM_HEADLESS:false}
    retry:
      attempts: ${SELENIUM_RETRY_ATTEMPTS:3}
    profiles:
      path: ${SELENIUM_PROFILES_PATH:./selenium-profiles}
    test-mode: ${TEST_MODE:false}
      
  # ===============================
  # ADDITIONAL SERVICE CONFIGURATION
  # ===============================
  # All prices and amounts are in USDT
  
  email:
    enabled: ${EMAIL_ENABLED:false}
    from: ${EMAIL_FROM:noreply@smmpanel.com}
    
  error-recovery:
    max-retries: ${ERROR_RECOVERY_MAX_RETRIES:3}
    initial-delay-minutes: ${ERROR_RECOVERY_INITIAL_DELAY_MINUTES:5}
    max-delay-hours: ${ERROR_RECOVERY_MAX_DELAY_HOURS:24}
    backoff-multiplier: ${ERROR_RECOVERY_BACKOFF_MULTIPLIER:2.0}
    
  dead-letter-queue:
    retention-days: ${DLQ_RETENTION_DAYS:30}
    max-entries: ${DLQ_MAX_ENTRIES:10000}

# ===============================
# RESILIENCE4J CONFIGURATION
# ===============================
resilience4j:
  circuitbreaker:
    instances:
      # Binom V2 API Circuit Breaker - Enhanced configuration
      binom-api:
        failure-rate-threshold: ${BINOM_CB_FAILURE_RATE_THRESHOLD:45}
        slow-call-rate-threshold: ${BINOM_CB_SLOW_CALL_RATE_THRESHOLD:40}
        slow-call-duration-threshold: ${BINOM_CB_SLOW_CALL_DURATION:PT8S}
        wait-duration-in-open-state: ${BINOM_CB_WAIT_DURATION_OPEN:PT45S}
        minimum-number-of-calls: ${BINOM_CB_MIN_CALLS:15}
        sliding-window-size: ${BINOM_CB_SLIDING_WINDOW_SIZE:30}
        sliding-window-type: ${BINOM_CB_SLIDING_WINDOW_TYPE:COUNT_BASED}
        permitted-number-of-calls-in-half-open-state: ${BINOM_CB_HALF_OPEN_CALLS:5}
        max-wait-duration-in-half-open-state: ${BINOM_CB_MAX_WAIT_HALF_OPEN:PT15S}
        automatic-transition-from-open-to-half-open-enabled: true
        # V2 specific configurations
        record-exceptions:
          - java.net.ConnectException
          - java.net.SocketTimeoutException
          - org.springframework.web.client.ResourceAccessException
          - com.smmpanel.exception.BinomApiException
        ignore-exceptions:
          - com.smmpanel.exception.BinomAuthenticationException
          - java.lang.IllegalArgumentException
      # Binom V2 specific endpoints circuit breakers
      binom-campaigns:
        failure-rate-threshold: 40
        slow-call-rate-threshold: 35
        slow-call-duration-threshold: PT6S
        wait-duration-in-open-state: PT30S
        minimum-number-of-calls: 10
        sliding-window-size: 20
      binom-statistics:
        failure-rate-threshold: 50
        slow-call-rate-threshold: 45
        slow-call-duration-threshold: PT10S
        wait-duration-in-open-state: PT60S
        minimum-number-of-calls: 8
        sliding-window-size: 15
      youtube-api:
        failure-rate-threshold: 60
        slow-call-duration-threshold: PT10S
        wait-duration-in-open-state: PT2M
      payment-api:
        failure-rate-threshold: 40
        slow-call-duration-threshold: PT8S
        wait-duration-in-open-state: PT1M
      # Cryptomus API Circuit Breaker
      cryptomus-api:
        failure-rate-threshold: ${CRYPTOMUS_CB_FAILURE_RATE_THRESHOLD:50}
        slow-call-rate-threshold: ${CRYPTOMUS_CB_SLOW_CALL_RATE_THRESHOLD:40}
        slow-call-duration-threshold: ${CRYPTOMUS_CB_SLOW_CALL_DURATION:PT5S}
        wait-duration-in-open-state: ${CRYPTOMUS_CB_WAIT_DURATION_OPEN:PT30S}
        minimum-number-of-calls: ${CRYPTOMUS_CB_MIN_CALLS:10}
        sliding-window-size: ${CRYPTOMUS_CB_SLIDING_WINDOW_SIZE:20}
        sliding-window-type: COUNT_BASED
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
        record-exceptions:
          - java.net.ConnectException
          - java.net.SocketTimeoutException
          - org.springframework.web.client.ResourceAccessException
        ignore-exceptions:
          - java.lang.IllegalArgumentException
  retry:
    instances:
      # Binom V2 API Retry - Enhanced configuration
      binom-api:
        max-attempts: ${BINOM_RETRY_MAX_ATTEMPTS:4}
        wait-duration: ${BINOM_RETRY_WAIT_DURATION:PT2S}
        exponential-backoff-multiplier: ${BINOM_RETRY_BACKOFF_MULTIPLIER:1.8}
        max-retry-attempts: ${BINOM_RETRY_MAX_RETRY_ATTEMPTS:4}
        # V2 specific retry configurations
        retry-exceptions:
          - java.net.ConnectException
          - java.net.SocketTimeoutException
          - org.springframework.web.client.ResourceAccessException
          - com.smmpanel.exception.BinomTemporaryException
        ignore-exceptions:
          - com.smmpanel.exception.BinomAuthenticationException
          - com.smmpanel.exception.BinomValidationException
          - java.lang.IllegalArgumentException
      # Binom V2 endpoint-specific retry policies
      binom-campaigns:
        max-attempts: 3
        wait-duration: PT1S
        exponential-backoff-multiplier: 2.0
      binom-statistics:
        max-attempts: 2
        wait-duration: PT3S
        exponential-backoff-multiplier: 1.5
      youtube-api:
        max-attempts: 2
        wait-duration: PT2S
      payment-api:
        max-attempts: 2
        wait-duration: PT3S
      # Cryptomus API Retry
      cryptomus-api:
        max-attempts: ${CRYPTOMUS_RETRY_MAX_ATTEMPTS:3}
        wait-duration: ${CRYPTOMUS_RETRY_WAIT_DURATION:PT2S}
        exponential-backoff-multiplier: 2.0
        retry-exceptions:
          - java.net.ConnectException
          - java.net.SocketTimeoutException
        ignore-exceptions:
          - java.lang.IllegalArgumentException
  # Binom V2 Bulkhead configuration
  bulkhead:
    instances:
      binom-api:
        max-concurrent-calls: ${BINOM_BULKHEAD_MAX_CALLS:25}
        max-wait-duration: ${BINOM_BULKHEAD_MAX_WAIT:PT10S}
      binom-campaigns:
        max-concurrent-calls: 15
        max-wait-duration: PT8S
      binom-statistics:
        max-concurrent-calls: 10
        max-wait-duration: PT12S
  # Binom V2 Rate Limiter configuration
  ratelimiter:
    instances:
      binom-api:
        limit-for-period: ${BINOM_RATE_LIMIT_PERIOD:30}
        limit-refresh-period: ${BINOM_RATE_LIMIT_REFRESH:PT1M}
        timeout-duration: ${BINOM_RATE_LIMIT_TIMEOUT:PT5S}
      binom-campaigns:
        limit-for-period: 20
        limit-refresh-period: PT1M
        timeout-duration: PT3S
      binom-statistics:
        limit-for-period: 15
        limit-refresh-period: PT1M
        timeout-duration: PT8S

# ===============================
# MONITORING & OBSERVABILITY
# ===============================
management:
  tracing:
    enabled: false  # Disable OpenTelemetry tracing
    sampling:
      probability: 0.0  # Disable all tracing
  otlp:
    metrics:
      export:
        enabled: false  # Disable OTLP metrics export
    tracing:
      endpoint: ""  # Disable OTLP exporter
      enabled: false  # Explicitly disable OTLP tracing
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,loggers,kafka,env,threaddump,heapdump
      base-path: /actuator
    jmx:
      exposure:
        include: "*"
  endpoint:
    health:
      show-details: when-authorized
      probes:
        enabled: true
    metrics:
      enabled: true
    info:
      enabled: true
    kafka:
      enabled: true
  prometheus:
    metrics:
      export:
        enabled: true
  metrics:
    enable:
      jvm: true
      process: true
      system: true
      tomcat: true
      kafka: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
        payment.processing.time: true
  health:
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true
    redis:
      enabled: true
    db:
      enabled: true
    kafka:
      enabled: true

# ===============================
# APPLICATION INFO
# ===============================
info:
  app:
    name: SMM Panel
    version: "@project.version@"
    description: Social Media Marketing Panel
    encoding: "@project.build.sourceEncoding@"
    java:
      version: "@java.version@"

# ===============================
# LOGGING CONFIGURATION
# ===============================
logging:
  level:
    root: INFO
    com.smmpanel: DEBUG
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.hibernate.type: TRACE
    org.springframework.orm.jpa: DEBUG
    org.springframework.transaction: DEBUG
  pattern:
    console: >
      "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: >
      "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ${LOG_FILE_PATH:/var/log/smm-panel/application.log}
  logback:
    rollingpolicy:
      max-file-size: 100MB
      total-size-cap: 1GB
      max-history: 30
