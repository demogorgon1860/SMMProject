<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog 
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- 
    v1.0.0 - Baseline Migration from Flyway
    
    This changeset establishes the baseline schema state matching the current Flyway migrations.
    It marks all existing tables and structures as already applied to prevent re-creation.
    
    Context: migration (one-time migration from Flyway)
    Rollback: Not applicable (baseline cannot be rolled back)
    -->

    <changeSet id="1.0.0-baseline-schema-validation" author="system" context="migration">
        <comment>Validate that the existing Flyway schema is compatible with Liquibase migration</comment>
        
        <preConditions onFail="HALT">
            <tableExists tableName="users"/>
            <tableExists tableName="orders"/>
            <tableExists tableName="services"/>
            <tableExists tableName="balance_transactions"/>
            <tableExists tableName="balance_deposits"/>
            <tableExists tableName="video_processing"/>
            <tableExists tableName="binom_campaigns"/>
            <tableExists tableName="fixed_binom_campaigns"/>
            <tableExists tableName="conversion_coefficients"/>
            <tableExists tableName="youtube_accounts"/>
            <tableExists tableName="view_stats"/>
            <tableExists tableName="traffic_sources"/>
            <tableExists tableName="operator_log"/>
            <tableExists tableName="binom_configuration"/>
        </preConditions>

        <!-- Mark Flyway migrations as applied in Liquibase -->
        <tagDatabase tag="flyway-baseline-v1.7"/>
        
        <!-- Create Liquibase-specific tracking views -->
        <createView viewName="v_liquibase_migration_status" replaceIfExists="true">
            <![CDATA[
            SELECT 
                'flyway-to-liquibase-migration' as migration_type,
                NOW() as migrated_at,
                'Baseline schema established from Flyway migrations V1.1 through V2025_08_11_2' as description,
                (SELECT COUNT(*) FROM information_schema.tables 
                 WHERE table_schema = current_schema() 
                 AND table_type = 'BASE TABLE') as table_count,
                (SELECT COUNT(*) FROM information_schema.table_constraints 
                 WHERE constraint_schema = current_schema() 
                 AND constraint_type = 'FOREIGN KEY') as fk_count,
                (SELECT COUNT(*) FROM pg_indexes 
                 WHERE schemaname = current_schema()) as index_count
            ]]>
        </createView>

        <rollback>
            <comment>Baseline migration cannot be rolled back - would require manual schema recreation</comment>
            <dropView viewName="v_liquibase_migration_status"/>
        </rollback>
    </changeSet>

    <changeSet id="1.0.0-add-migration-metadata" author="system" context="migration">
        <comment>Add metadata table to track migration history and performance</comment>
        
        <createTable tableName="liquibase_migration_metadata">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="changeset_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="context" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="execution_time_ms" type="BIGINT"/>
            <column name="rows_affected" type="BIGINT"/>
            <column name="rollback_available" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="notes" type="TEXT"/>
            <column name="executed_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
            <column name="executed_by" type="VARCHAR(100)" defaultValue="system">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="liquibase_migration_metadata" indexName="idx_migration_metadata_version">
            <column name="version"/>
        </createIndex>
        
        <createIndex tableName="liquibase_migration_metadata" indexName="idx_migration_metadata_context">
            <column name="context"/>
        </createIndex>
        
        <createIndex tableName="liquibase_migration_metadata" indexName="idx_migration_metadata_executed_at">
            <column name="executed_at"/>
        </createIndex>

        <!-- Insert baseline record -->
        <insert tableName="liquibase_migration_metadata">
            <column name="changeset_id" value="1.0.0-baseline-from-flyway"/>
            <column name="version" value="1.0.0"/>
            <column name="context" value="migration"/>
            <column name="execution_time_ms" value="0"/>
            <column name="rollback_available" valueBoolean="false"/>
            <column name="notes" value="Baseline migration from Flyway schema V1.1 through V2025_08_11_2"/>
        </insert>

        <rollback>
            <dropTable tableName="liquibase_migration_metadata"/>
        </rollback>
    </changeSet>

</databaseChangeLog>