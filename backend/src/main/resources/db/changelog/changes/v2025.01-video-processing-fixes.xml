<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ========================================== -->
    <!-- VIDEO PROCESSING TABLE FIXES - January 2025 -->
    <!-- Adds all missing columns to video_processing table -->
    <!-- ========================================== -->
    
    <!-- Add status column -->
    <changeSet id="2025.01-video-status" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <not>
                <columnExists tableName="video_processing" columnName="status"/>
            </not>
        </preConditions>
        <addColumn tableName="video_processing">
            <column name="status" type="VARCHAR(32)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    
    <!-- Add video_id column -->
    <changeSet id="2025.01-video-video-id" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <not>
                <columnExists tableName="video_processing" columnName="video_id"/>
            </not>
        </preConditions>
        <addColumn tableName="video_processing">
            <column name="video_id" type="VARCHAR(100)"/>
        </addColumn>
    </changeSet>
    
    <!-- Add video_type column -->
    <changeSet id="2025.01-video-video-type" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <not>
                <columnExists tableName="video_processing" columnName="video_type"/>
            </not>
        </preConditions>
        <addColumn tableName="video_processing">
            <column name="video_type" type="VARCHAR(32)"/>
        </addColumn>
    </changeSet>
    
    <!-- Add processing_attempts column -->
    <changeSet id="2025.01-video-processing-attempts" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <not>
                <columnExists tableName="video_processing" columnName="processing_attempts"/>
            </not>
        </preConditions>
        <addColumn tableName="video_processing">
            <column name="processing_attempts" type="INTEGER" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>
    
    <!-- Add youtube_account_id column -->
    <changeSet id="2025.01-video-youtube-account-id" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <not>
                <columnExists tableName="video_processing" columnName="youtube_account_id"/>
            </not>
        </preConditions>
        <addColumn tableName="video_processing">
            <column name="youtube_account_id" type="BIGINT"/>
        </addColumn>
    </changeSet>
    
    <!-- Add last_processed_at column -->
    <changeSet id="2025.01-video-0" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <not>
                <columnExists tableName="video_processing" columnName="last_processed_at"/>
            </not>
        </preConditions>
        <addColumn tableName="video_processing">
            <column name="last_processed_at" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
    </changeSet>
    
    <!-- Add last_error_at column -->
    <changeSet id="2025.01-video-1" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <not>
                <columnExists tableName="video_processing" columnName="last_error_at"/>
            </not>
        </preConditions>
        <addColumn tableName="video_processing">
            <column name="last_error_at" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
    </changeSet>

    <!-- Add any other potentially missing columns based on entity requirements -->
    <changeSet id="2025.01-video-2" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <not>
                <columnExists tableName="video_processing" columnName="retry_count"/>
            </not>
        </preConditions>
        <addColumn tableName="video_processing">
            <column name="retry_count" type="INTEGER" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.01-video-3" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <not>
                <columnExists tableName="video_processing" columnName="max_retries"/>
            </not>
        </preConditions>
        <addColumn tableName="video_processing">
            <column name="max_retries" type="INTEGER" defaultValueNumeric="3"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.01-video-4" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <not>
                <columnExists tableName="video_processing" columnName="error_message"/>
            </not>
        </preConditions>
        <addColumn tableName="video_processing">
            <column name="error_message" type="TEXT"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.01-video-5" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <not>
                <columnExists tableName="video_processing" columnName="processing_duration_ms"/>
            </not>
        </preConditions>
        <addColumn tableName="video_processing">
            <column name="processing_duration_ms" type="BIGINT"/>
        </addColumn>
    </changeSet>

    <!-- Add indexes for better query performance -->
    <changeSet id="2025.01-video-6" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <columnExists tableName="video_processing" columnName="status"/>
            <not>
                <indexExists tableName="video_processing" indexName="idx_video_processing_status"/>
            </not>
        </preConditions>
        <createIndex tableName="video_processing" indexName="idx_video_processing_status">
            <column name="status"/>
        </createIndex>
    </changeSet>

    <changeSet id="2025.01-video-7" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <columnExists tableName="video_processing" columnName="created_at"/>
            <not>
                <indexExists tableName="video_processing" indexName="idx_video_processing_created"/>
            </not>
        </preConditions>
        <createIndex tableName="video_processing" indexName="idx_video_processing_created">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>