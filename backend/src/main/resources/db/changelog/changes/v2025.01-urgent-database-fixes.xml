<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ========================================== -->
    <!-- URGENT DATABASE FIXES - January 2025 -->
    <!-- Fixes critical missing columns and enum type issues -->
    <!-- ========================================== -->
    
    <!-- 1. Add missing last_login_at column to users table -->
    <changeSet id="2025.01-urgent-1" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="last_login_at"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="last_login_at" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
        <sql>
            -- Add index for last_login_at column for better query performance
            CREATE INDEX IF NOT EXISTS idx_users_last_login ON users(last_login_at);
        </sql>
    </changeSet>

    <!-- 2. Fix order_status enum type - add missing values -->
    <changeSet id="2025.01-urgent-2" author="system">
        <sql splitStatements="false">
            -- First check if ERROR value exists in enum
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 
                    FROM pg_enum 
                    WHERE enumtypid = 'order_status'::regtype 
                    AND enumlabel = 'ERROR'
                ) THEN
                    ALTER TYPE order_status ADD VALUE IF NOT EXISTS 'ERROR';
                END IF;
            END$$;
        </sql>
    </changeSet>

    <changeSet id="2025.01-urgent-3" author="system">
        <sql splitStatements="false">
            -- Check if SUSPENDED value exists in enum
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 
                    FROM pg_enum 
                    WHERE enumtypid = 'order_status'::regtype 
                    AND enumlabel = 'SUSPENDED'
                ) THEN
                    ALTER TYPE order_status ADD VALUE IF NOT EXISTS 'SUSPENDED';
                END IF;
            END$$;
        </sql>
    </changeSet>

    <!-- 3. Fix the orders.status column if it's using wrong type -->
    <changeSet id="2025.01-urgent-4" author="system">
        <sql splitStatements="false">
            -- Check the current type of status column and fix if needed
            DO $$
            DECLARE
                current_type TEXT;
            BEGIN
                -- Get the current data type of the status column
                SELECT data_type INTO current_type
                FROM information_schema.columns
                WHERE table_name = 'orders' 
                AND column_name = 'status';
                
                -- If it's CHARACTER VARYING, we need to convert it to enum
                IF current_type = 'character varying' THEN
                    -- First create a temporary column
                    ALTER TABLE orders ADD COLUMN status_temp order_status;
                    
                    -- Copy data with proper casting
                    UPDATE orders 
                    SET status_temp = status::order_status 
                    WHERE status IS NOT NULL;
                    
                    -- Drop the old column
                    ALTER TABLE orders DROP COLUMN status;
                    
                    -- Rename the temporary column
                    ALTER TABLE orders RENAME COLUMN status_temp TO status;
                    
                    -- Set default value
                    ALTER TABLE orders ALTER COLUMN status SET DEFAULT 'PENDING'::order_status;
                    
                    -- Recreate index if it was dropped
                    CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
                END IF;
            END$$;
        </sql>
    </changeSet>

    <!-- 4. Add other missing user table columns that might be expected -->
    <changeSet id="2025.01-urgent-5" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="last_api_access"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="last_api_access" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
        <sql>
            -- Add index for last_api_access column
            CREATE INDEX IF NOT EXISTS idx_users_last_api_access ON users(last_api_access);
        </sql>
    </changeSet>

    <changeSet id="2025.01-urgent-6" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="api_key_hash"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="api_key_hash" type="VARCHAR(64)"/>
        </addColumn>
        <sql>
            -- Add index for api_key_hash for fast lookups
            CREATE INDEX IF NOT EXISTS idx_users_api_key_hash ON users(api_key_hash);
        </sql>
    </changeSet>

    <changeSet id="2025.01-urgent-7" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="api_key_salt"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="api_key_salt" type="VARCHAR(64)"/>
        </addColumn>
        <sql>
            -- Add index for api_key_salt
            CREATE INDEX IF NOT EXISTS idx_users_api_key_salt ON users(api_key_salt);
        </sql>
    </changeSet>

    <changeSet id="2025.01-urgent-8" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="api_key_last_rotated"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="api_key_last_rotated" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.01-urgent-9" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="total_spent"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="total_spent" type="DECIMAL(12,2)" defaultValueNumeric="0.00"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.01-urgent-10" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="password_changed_at"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="password_changed_at" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.01-urgent-11" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="email_verified"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="email_verified" type="BOOLEAN" defaultValueBoolean="false"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.01-urgent-12" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="failed_login_attempts"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="failed_login_attempts" type="INTEGER" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.01-urgent-13" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="account_locked"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="account_locked" type="BOOLEAN" defaultValueBoolean="false"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.01-urgent-14" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="failed_attempts"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="failed_attempts" type="INTEGER" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.01-urgent-15" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="lock_time"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="lock_time" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.01-urgent-16" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="locked_until"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="locked_until" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.01-urgent-17" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="users" columnName="version"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="version" type="BIGINT" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <!-- 5. Ensure balance_transactions table exists (referenced in User entity) -->
    <changeSet id="2025.01-urgent-18" author="system">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="balance_transactions"/>
            </not>
        </preConditions>
        <createTable tableName="balance_transactions">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_balance_tx_user" references="users(id)"/>
            </column>
            <column name="amount" type="DECIMAL(12,2)">
                <constraints nullable="false"/>
            </column>
            <column name="balance_before" type="DECIMAL(12,2)">
                <constraints nullable="false"/>
            </column>
            <column name="balance_after" type="DECIMAL(12,2)">
                <constraints nullable="false"/>
            </column>
            <column name="transaction_type" type="transaction_type">
                <constraints nullable="false"/>
            </column>
            <column name="reference_id" type="VARCHAR(100)"/>
            <column name="description" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2025.01-urgent-19" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="balance_transactions"/>
        </preConditions>
        <createIndex tableName="balance_transactions" indexName="idx_balance_tx_user_id">
            <column name="user_id"/>
        </createIndex>
        <createIndex tableName="balance_transactions" indexName="idx_balance_tx_created_at">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <!-- 6. Fix video_processing table - add missing completed_at column -->
    <changeSet id="2025.01-urgent-20" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="video_processing"/>
            <not>
                <columnExists tableName="video_processing" columnName="completed_at"/>
            </not>
        </preConditions>
        <addColumn tableName="video_processing">
            <column name="completed_at" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
    </changeSet>

    <!-- 7. Log completion message -->
    <changeSet id="2025.01-urgent-21" author="system">
        <sql>
            -- Log successful completion of urgent fixes
            INSERT INTO databasechangelog (id, author, filename, dateexecuted, orderexecuted, exectype, description, comments)
            VALUES ('urgent-fixes-complete', 'system', 'v2025.01-urgent-database-fixes.xml', NOW(), 
                    (SELECT COALESCE(MAX(orderexecuted), 0) + 1 FROM databasechangelog), 
                    'EXECUTED', 'Urgent database fixes completed', 
                    'Fixed missing users.last_login_at column, order_status enum type issues, and video_processing.completed_at column')
            ON CONFLICT DO NOTHING;
        </sql>
    </changeSet>

</databaseChangeLog>